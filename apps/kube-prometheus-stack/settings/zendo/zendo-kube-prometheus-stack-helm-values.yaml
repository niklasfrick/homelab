prometheus:
  prometheusSpec:
    replicas: 2
    # Increased from 6h to 12h to provide overlap between sidecar and StoreGateway
    # This ensures blocks are available via sidecar long enough for StoreGateway to sync them
    retention: 6h
    retentionSize: "3GiB"
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: ceph-block
          resources:
            requests:
              storage: 5Gi
    thanos:
      objectStorageConfig:
        existingSecret:
          name: thanos-s3-keys
          key: thanos-object-storage-config.yaml
      additionalArgs:
        - name: shipper.upload-compacted
  thanosService:
    enabled: true
  thanosServiceMonitor:
    enabled: true

alertmanager:
  templateFiles:
    telegram.tmpl: |-
      {{- define "telegram.message" -}}
      {{- $maxAlerts := 3 -}}
      {{- $totalAlerts := len .Alerts -}}
      {{- if eq .Status "firing" -}}üî• {{- end -}}{{- if eq .Status "resolved" -}}‚úÖ {{- end -}}<b>[{{ .Status | toUpper }}] [zendo] {{ .CommonLabels.alertname }}{{ if .CommonLabels.instance }} on {{ .CommonLabels.instance }}{{ end }}</b>
      {{ "\n" }}
      {{- if gt $totalAlerts $maxAlerts }}
      <i>Showing first {{ $maxAlerts }} of {{ $totalAlerts }} alerts to stay within Telegram message size limits.</i>
      {{ "\n" }}
      {{- end }}
      {{- if gt $totalAlerts $maxAlerts -}}
      {{- range $i, $alert := (slice .Alerts 0 $maxAlerts) -}}
      {{- if gt $i 0 }}{{ "\n\n" }}{{- end -}}
      {{- template "telegram.alert" $alert -}}
      {{- end -}}
      {{- else -}}
      {{- range $i, $alert := .Alerts -}}
      {{- if gt $i 0 }}{{ "\n\n" }}{{- end -}}
      {{- template "telegram.alert" $alert -}}
      {{- end -}}
      {{- end }}
      {{ "\n\n" }}
      <a href="https://grafana.apps.949x.net/alerting/list?view=state">Go to Grafana</a>
      {{- end -}}
      {{- define "telegram.alert" -}}
      {{$severity := .Labels.severity -}}
      {{- if eq $severity "warning" }}
      <b>Severity: </b> WARNING ‚ö†Ô∏è
      {{- else if eq $severity "critical" }}
      <b>Severity: </b> CRITICAL üö®
      {{- else }}
      <b>Severity: </b> {{$severity | toUpper }} üò±
      {{- end }}
      {{- $status := .Status -}}
      {{- if eq $status "firing" }}
      <b>Date/Time: </b> {{ .StartsAt.Format "Mon 02 Jan 15:04:05 MST 2006" }}
      {{- else if eq $status "resolved" }}
      <b>Date/Time: </b> {{ .EndsAt.Format "Mon 02 Jan 15:04:05 MST 2006" }}
      {{- end }}
      <b>Alert: </b> {{ .Labels.alertname }}
      <b>Description: </b> {{ printf "%.240s" .Annotations.description }}

      <b>Details: </b>
      {{- if .Labels.instance }}
        - <i>Instance</i>: <code>{{ .Labels.instance }}</code>
      {{- end }}
      {{- if .Labels.job }}
        - <i>Job</i>: <code>{{ .Labels.job }}</code>
      {{- end }}
      {{- if .Labels.namespace }}
        - <i>Namespace</i>: <code>{{ .Labels.namespace }}</code>
      {{- end }}
      {{- if .Annotations.runbook_url }}

      Runbook: {{ .Annotations.runbook_url }}
      {{- end }}
      {{- end -}}

  alertmanagerSpec:
    externalUrl: "https://grafana.apps.949x.net/alerting/list?view=state"
